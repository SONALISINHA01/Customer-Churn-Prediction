{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1c04d972-aa97-4ed6-8afc-c4a5dab29bac",
   "metadata": {},
   "outputs": [],
   "source": [
    "import streamlit as st\n",
    "import pandas as pd\n",
    "import networkx as nx\n",
    "import torch\n",
    "import matplotlib.pyplot as plt\n",
    "from torch_geometric.nn import GCNConv\n",
    "import torch.nn.functional as F\n",
    "\n",
    "# --- 1. DEFINE THE MODEL ARCHITECTURE ---\n",
    "# (We must define the class so PyTorch knows what structure to load weights into)\n",
    "class ChurnGNN(torch.nn.Module):\n",
    "    def __init__(self):\n",
    "        super().__init__()\n",
    "        self.conv1 = GCNConv(3, 32)\n",
    "        self.conv2 = GCNConv(32, 2)\n",
    "\n",
    "    def forward(self, data):\n",
    "        x, edge_index = data.x, data.edge_index\n",
    "        x = self.conv1(x, edge_index)\n",
    "        x = F.relu(x)\n",
    "        x = F.dropout(x, p=0.5, training=self.training)\n",
    "        x = self.conv2(x, edge_index)\n",
    "        return F.log_softmax(x, dim=1)\n",
    "\n",
    "# --- 2. LOAD THE SAVED SYSTEM ---\n",
    "st.set_page_config(page_title=\"Churn Contagion Guard\", layout=\"wide\")\n",
    "\n",
    "@st.cache_resource # Caches the model so it loads only once!\n",
    "def load_trained_system():\n",
    "    try:\n",
    "        # Load the checkpoint file\n",
    "        checkpoint = torch.load('churn_system.pth')\n",
    "        \n",
    "        # Restore Data\n",
    "        G = checkpoint['graph_G']\n",
    "        df = checkpoint['data_df']\n",
    "        \n",
    "        # Restore Model\n",
    "        model = ChurnGNN()\n",
    "        model.load_state_dict(checkpoint['model_state'])\n",
    "        model.eval() # Set to evaluation mode (no training)\n",
    "        \n",
    "        return model, G, df\n",
    "        \n",
    "    except FileNotFoundError:\n",
    "        st.error(\"‚ùå File 'churn_system.pth' not found! Please run the notebook to generate it.\")\n",
    "        return None, None, None\n",
    "\n",
    "model, G, df = load_trained_system()\n",
    "\n",
    "if model is not None:\n",
    "    # --- 3. SIDEBAR CONTROLS ---\n",
    "    st.sidebar.title(\"üîç Contagion Inspector\")\n",
    "    st.sidebar.markdown(\"Select a customer to visualize their hidden 'Risk Network'.\")\n",
    "\n",
    "    # Search box\n",
    "    if 'customerID' in df.columns:\n",
    "        all_users = df['customerID'].unique()\n",
    "        selected_user = st.sidebar.selectbox(\"Search Customer ID:\", all_users)\n",
    "    else:\n",
    "        st.error(\"Dataframe missing customerID column.\")\n",
    "        st.stop()\n",
    "\n",
    "    # --- 4. MAIN DASHBOARD ---\n",
    "    st.title(\"üõ°Ô∏è Dynamic Churn Prediction System\")\n",
    "    st.markdown(\"### Model Status: üü¢ Pre-Trained & Ready\")\n",
    "\n",
    "    col1, col2 = st.columns([2, 1])\n",
    "\n",
    "    with col1:\n",
    "        st.subheader(f\"Network Visualization for {selected_user}\")\n",
    "        \n",
    "        try:\n",
    "            # Visualize Subgraph\n",
    "            if selected_user in G:\n",
    "                neighbors = list(G.neighbors(selected_user))\n",
    "                sub_nodes = [selected_user] + neighbors\n",
    "                sub_G = G.subgraph(sub_nodes)\n",
    "                \n",
    "                fig, ax = plt.subplots(figsize=(8, 6))\n",
    "                \n",
    "                # Colors: Gold (Target), Red (Churned), Green (Safe)\n",
    "                colors = []\n",
    "                for node in sub_G.nodes():\n",
    "                    is_churned = df[df['customerID'] == node]['Churn'].values[0] == 1\n",
    "                    if node == selected_user:\n",
    "                        colors.append('gold')\n",
    "                    elif is_churned:\n",
    "                        colors.append('#ff4b4b') # Red\n",
    "                    else:\n",
    "                        colors.append('#90EE90') # Green\n",
    "                \n",
    "                pos = nx.spring_layout(sub_G, seed=42)\n",
    "                nx.draw(sub_G, pos, with_labels=True, node_color=colors, node_size=1200, font_size=9, ax=ax, edge_color='gray')\n",
    "                st.pyplot(fig)\n",
    "            else:\n",
    "                st.warning(\"This user has no hidden error connections in the graph.\")\n",
    "                \n",
    "        except Exception as e:\n",
    "            st.error(f\"Visualization Error: {e}\")\n",
    "\n",
    "    with col2:\n",
    "        st.subheader(\"‚ö†Ô∏è Risk Analysis\")\n",
    "        \n",
    "        if selected_user in G:\n",
    "            risk_score = len([n for n in neighbors if df[df['customerID'] == n]['Churn'].values[0] == 1])\n",
    "            total_neighbors = len(neighbors)\n",
    "            \n",
    "            st.metric(label=\"Hidden Connections\", value=total_neighbors)\n",
    "            st.metric(label=\"Infected Neighbors\", value=risk_score, delta_color=\"inverse\")\n",
    "            \n",
    "            if risk_score > 0:\n",
    "                st.error(f\"**ALERT:** {selected_user} is linked to {risk_score} churned users.\")\n",
    "                st.button(f\"üöÄ Deploy Retention Offer\")\n",
    "            else:\n",
    "                st.success(\"User is in a safe cluster.\")\n",
    "        else:\n",
    "            st.info(\"No risk data available for this user.\")\n",
    "\n",
    "    # --- 5. EXPLANATION ---\n",
    "    st.markdown(\"---\")\n",
    "    st.info(\"‚ÑπÔ∏è **System Info:** This dashboard is loading a pre-trained Graph Neural Network from `churn_system.pth`. No training is happening in real-time.\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
